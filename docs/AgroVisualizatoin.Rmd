---
title: "中国农险行业数据分析"
output:
  html_document:
    highlight: tango
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
    # css: styles.css
    header-includes:
      - <meta name="viewport" content="width=device-width, initial-scale=1">
---

<style>

  .toc-content {
    padding: 0px !important;
    margin: 0px !important;
  }
  
  div.main-container {
    max-width: 95% !important;
    margin-left: 0; !important
    padding: 0 !importance;
    margin-right: auto;
  }
  
  #TOC {
    <!-- max-width: 95% !important; -->
    padding: 0px !important;
    margin: 0px !important;
  }
  
  .svg-container {
    padding: 0 !important;
    margin: 0 !important;
  }
  
  .bg {
    padding: 0 !important;
    margin: 0 !important;
  }
  
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo=FALSE)
```


```{r cache=FALSE}
library(readxl)
library(writexl) 
library(dplyr)
library(ggplot2)
library(plotly)
library(sf)
library(foreach)
library(knitr)
library(kableExtra)
library(hchinamap)
library(leafletCN)
library(RColorBrewer)
library(DT)
library(reshape2)
library(htmltools)
library(base64enc)
library(downloadthis)
library(manipulateWidget)
htmltools::tagList( # for the icons
  rmarkdown::html_dependency_font_awesome()
)
options(encoding = "UTF-8")

```

```{r}
# 文件读取路径（可调整）
db.path <- "D:/ly/task/ChinaRe/Agro DB - 20230322.xlsx"
db.sheet.name <- "db"
mapping.path <- "D:/ly/task/ChinaRe/Mapping.xlsx"
mapping.biaodi.sheet <- "标的分类"
mapping.jigou.sheet <- "市场主体类型"

# 必需加载的外部文件路径
work.path <- "D:/ly/task/ChinaRe/Visualization/"

```


```{r warning=FALSE, message=FALSE, include=FALSE, cache=TRUE}
Crop <- read_excel(path = db.path, sheet = db.sheet.name)

# 规则0：签单保费为0的数据不合格
Crop$R0 <- ifelse(Crop$签单保费==0,
                  formatC(0, digits = 2, width = 2, format = "d", flag = "0"),NA)

# 规则1：产品代码或标的代码为空
Crop$R1 <- ifelse(is.na(Crop$产品代码)|is.na(Crop$标的代码),
                  formatC(1, digits = 2, width = 2, format = "d", flag = "0"),NA)

# 规则2：已决赔款＞0且保险金额=0的赔案数据不合格
Crop$R2 <- ifelse(Crop$已决赔款>0&Crop$保险金额==0,
                  formatC(2, digits = 2, width = 2, format = "d", flag = "0"),NA)

# 规则3：签单保费＞保险金额的赔案数据不合格
Crop$R3 <- ifelse(Crop$签单保费>Crop$保险金额,
                  formatC(3, digits = 2, width = 2, format = "d", flag = "0"),NA)

# 规则4：已决赔款＞保险金额的赔案数据不合格
Crop$R4 <- ifelse(Crop$已决赔款>Crop$保险金额,
                  formatC(4, digits = 2, width = 2, format = "d", flag = "0"),NA)

# 规则5：受益户次＞承保户次的赔案数据不合格
Crop$R5 <- ifelse(Crop$受益户次>Crop$承保户次,
                  formatC(5, digits = 2, width = 2, format = "d", flag = "0"),NA)

# 规则6：筛查重复项，跨年份的赔案
Crop <- Crop %>% group_by_all() %>%
  mutate(R6 = ifelse(row_number()>1,formatC(6, digits = 2, width = 2, format = "d", flag = "0"),NA)) %>%
  as.data.frame()


Crop$ALLR <- sapply(X = 1:nrow(Crop), FUN = function(X) {
  tag <- unlist(Crop[X,c("R0","R1","R2","R3","R4","R5","R6")])
  flag <- is.na(tag)
  if(sum(flag)==7)
    return(NA)
  else
    return(paste0(tag[!flag], collapse="-"))
})

# 规范险种名
Crop$Class[which(Crop$Class=="Crop")] <- "种植险"
Crop$Class[which(Crop$Class=="Livestock")] <- "养殖险"
Crop$Class[which(Crop$Class=="Forestry")] <- "森林险"

# 规范省名称
china.data <- jsonlite::fromJSON(paste0(work.path, "china.json"), simplifyVector = F)
china.df <- foreach(i=1:length(china.data$features), .combine = "rbind") %do% {
  return(unname(unlist(c(china.data$features[[i]]$id, china.data$features[[i]]$properties[1]))))
} %>% as.data.frame()
colnames(china.df) <- c("id", "name")
rownames(china.df) <- NULL
pro.name <- china.df$name

crop.pro.name <- Crop$省名称[!duplicated(Crop$省名称)]
for(i in 1:length(crop.pro.name)) {
  ix <- which((substring(pro.name,1,2)==substring(crop.pro.name[i],1,2)))
  Crop[which(Crop$省名称==crop.pro.name[i]), "省名称"] <- pro.name[ix]
}

# mapping标的代码
biaodi <- read_excel(path = mapping.path, sheet = mapping.biaodi.sheet)
biaodi$Class[which(biaodi$Class=="Crop")] <- "种植险"
biaodi$Class[which(biaodi$Class=="Livestock")] <- "养殖险"
biaodi$Class[which(biaodi$Class=="Forestry")] <- "森林险"

Crop$标的 <- NA
for(i in 1:nrow(biaodi)) {
  idx <- which(biaodi$Class[i]==Crop$Class & biaodi$标的分类代码[i]==Crop$标的代码)
  Crop[idx, "标的"] <- biaodi$标的名称分类[i]
}

# mapping公司类别
jigou <- read_excel(path = mapping.path, sheet = mapping.jigou.sheet)

Crop$机构 <- NA
for(i in 1:nrow(jigou)) {
  idx <- which(jigou$机构代码[i]==Crop$机构代码)
  Crop[idx, "机构"] <- jigou$市场主体类型[i]
}

```

# 保费指标分析

```{r include=FALSE}
my.palette <- brewer.pal(8, "Paired")
plot(1:length(my.palette), col = my.palette, pch = 19, cex = 4)
```

## 国内农业保险业务规模发展概况

```{r warning=FALSE, message=FALSE, fig.width=9, fig.height=4}
# 计算复合增速
Rate <- Crop %>%
  group_by(UY,进展期) %>%
  summarise(保费=sum(签单保费))
Rate <- data.frame(Rate)
Rate$UY <- as.numeric(Rate$UY)
sort.UY <- sort(Rate$UY[!duplicated(Rate$UY)])
for(UY in sort.UY[-1]) {
  for(i in 1:nrow(Rate)) {
    if(Rate$UY[i]!=UY)
      next
    ind <- which(Rate$UY==UY-1 & Rate$进展期==Rate[i,"进展期"])
    Rate[i,"增速"] <- Rate[i,"保费"] / Rate[ind,"保费"]-1
  }
}

Rate <- Rate %>%
  group_by(UY) %>%
  slice(which.max(进展期))



# 区分种森、养殖两类的图
Crop.copy <- Crop
Crop.copy$Class[which(Crop.copy$Class=="种植险" | Crop.copy$Class=="森林险")] <- "种植&森林险"

Volume <- Crop.copy %>%
  group_by(UY, 进展期, Class) %>%
  summarize(保费=sum(签单保费))

Volume <- Volume %>%
  group_by(UY, Class) %>%
  slice(which.max(进展期))

Volume <- merge(Volume, Rate[,c("UY","增速")], by="UY")


df1 <- Volume[, c("UY","Class","保费")]
df1$保费 <- df1$保费/1e8
external.df <- data.frame(
  UY = rep(2015:2019, each=2), 
  Class = rep(c("养殖险", "种植&森林险"), 5), 
  保费 = c(88.96,286,104.75,312,132.15,346,179.97,391,210.53,461))

df1 <- rbind(external.df, df1)

df1 <- reshape2::dcast(df1, UY ~ Class)

df2 <- Volume[, c("UY","增速")]
df2$增速 <- df2$增速*100
df2 <- df2[!duplicated(df2$UY), ]

df2[1, 2] <- 21.3
df2 <- rbind(
  data.frame(
  UY = c(2015:2019), 
  增速 = c(15.1, 11.3, 14.5, 19.6, 17.5)), 
  df2
)

my.color <- c("#93d14f", "#f4b284", my.palette)
p1 <- plot_ly(df1, x = ~UY, y = ~`种植&森林险`, type = 'bar', name = '种植&森林险') %>% 
  add_trace(y = ~养殖险, name = '养殖险') %>% 
  add_trace(data = df2, x = ~UY, y = ~增速, type = "scatter", mode = "lines+markers", 
            color = I("#2a76b7"), name = "保费复合增速", yaxis = "y2", 
            line = list(width = 2.0, dash = "dash")) %>% 
  layout(title = list(text = "农险行业保费结构及增速", x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)), 
         xaxis = list(title = '年份', dtick = 1), 
         yaxis = list(title = '保费(亿)'), 
         yaxis2 = list(overlaying = "y", side = "right", title = "保费复合增速(%)", range = c(0,30)), 
         margin = list(t = 15, r = 50), 
         legend = list(x = 0, y = 1, xanchor = 'left', yanchor = 'top'), 
         barmode = 'stack', 
         colorway = my.color, 
         bargap = 0.5)


# p1

# 种森险&养殖险保费增速对比
Rate <- Crop.copy %>%
  group_by(UY,进展期,Class) %>%
  summarise(保费=sum(签单保费))
Rate <- data.frame(Rate)
Rate$UY <- as.numeric(Rate$UY)
sort.UY <- sort(Rate$UY[!duplicated(Rate$UY)])
for(UY in sort.UY[-1]) {
  for(i in 1:nrow(Rate)) {
    if(Rate$UY[i]!=UY)
      next
    ind <- which(Rate$UY==UY-1 & Rate$进展期==Rate[i,"进展期"] & Rate$Class==Rate[i,"Class"])
    Rate[i,"增速"] <- (Rate[i,"保费"] / Rate[ind,"保费"]-1)*100
  }
}

Rate <- Rate %>%
  group_by(UY,Class) %>%
  slice(which.max(进展期))


df <- Rate[, c("UY", "Class", "增速")]

df[1,3] <- 34.03
df[2,3] <- 15.53
df <- rbind(
  data.frame(
  UY = rep(c(2016:2019), each=2), 
  Class = rep(c("养殖险", "种植&森林险"), 4), 
  增速 = c(17.75, 9.31, 26.16, 10.63, 36.19, 13.28, 16.98, 17.81)), 
  df
)

df <- reshape2::dcast(df, UY~Class)


p2 <- plot_ly(df, y = ~UY, x = ~`种植&森林险`, type = "bar", orientation = "h", name = "种植&森林险") %>%
  add_trace(x = ~养殖险, type = "bar", orientation = "h", name = "养殖险") %>% 
  layout(title = list(text = "种森险、养殖险保费增速对比", x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)), 
         xaxis = list(title = '保费增速(%)'), 
         yaxis = list(title = '年份', dtick = 1), 
         margin = list(t = 15), 
         colorway = my.color, 
         bargap = 0.5)

# p2

p <- combineWidgets(p1, p2, nrow = 1)

p


```


## 国内农业保险业务规模发展概况

```{r}
Crop2.2 <- Crop %>%
  group_by(UY, 进展期, 省名称) %>%
  summarize(保费=sum(签单保费))

Crop2.2 <- data.frame(Crop2.2)
Crop2.2$UY <- as.numeric(Crop2.2$UY)
sort.UY <- sort(Crop2.2$UY[!duplicated(Crop2.2$UY)])
for(UY in sort.UY[-1]) {
  for(i in 1:nrow(Crop2.2)) {
    if(Crop2.2$UY[i]!=UY)
      next
    ind <- which(Crop2.2$UY==UY-1 & Crop2.2$进展期==Crop2.2[i,"进展期"] & Crop2.2$省名称==Crop2.2[i,"省名称"])
    Crop2.2[i,"增速"] <- Crop2.2[i,"保费"] / Crop2.2[ind,"保费"]-1
  }
}

Crop2.2 <- Crop2.2 %>%
  group_by(UY, 省名称) %>%
  slice(which.max(进展期))

# latest year
year <- sort.UY[length(sort.UY)]
year.df <- Crop2.2[which(Crop2.2$UY==year), ]
if(year.df$进展期[1]>=4) {
  tab.title <- paste0(year, "年全国农险保费分省分布及增速")
  img.title <- paste0(year, "年全国农险保费分省分布")
} else {
  tab.title <- paste0(year, "年Q", year.df$进展期[1], "全国农险保费分省分布及增速")
  img.title <- paste0(year, "年Q", year.df$进展期[1], "全国农险保费分省分布")
}

```

```{r fig.width=9, fig.height=6}
province_centers <- data.frame(
  province = c("青海", "北京", "天津", "上海", "重庆", "河北", "山西", "辽宁", "吉林", 
               "黑龙江", "江苏", "浙江", "安徽", "福建", "江西", "山东", "河南", "湖北", 
               "湖南", "广东", "广西", "海南", "四川", "贵州", "云南", "西藏", "陕西", 
               "甘肃", "宁夏", "新疆", "台湾", "内蒙古"),
  lon = c(96.683140, 116.395645, 117.210813, 122, 107.504962, 115.661434, 112.515496, 
          123.431475, 126.965607, 127.5, 119.981861, 120.5, 117.284923, 118.306239, 
          115.910148, 118.149780, 113.631419, 112.410562, 111.720663, 113.394818, 108.924274, 
          109.733755, 102.899160, 106.734996, 101.592952, 89.137981, 108.360410, 103.826308, 
          106.155481, 87.627704, 121, 111.7510),
  lat = c(36.822069, 39.929986, 39.143930, 31.249162, 30.739223, 38.613840, 37.866566, 41.2, 
          43.886841, 47, 33, 29.182441, 31.861190, 26.074508, 27.614642, 36.250279, 
          34, 30.546498, 27.571990, 23.125178, 23.726101, 19.195993, 30.659462, 26.651204, 
          24.370447, 31.568735, 34.364080, 36.200202, 37.5, 43.8256, 23.5, 41.5)
)

year.df <- merge(year.df, china.df, by.x = "省名称", by.y = "name", all = TRUE)
year.df <- merge(year.df, province_centers, by.x = "省名称", by.y = "province", all.x = TRUE)

min.value <- min(year.df$保费/1e8, na.rm=T)
year.df$保费[is.na(year.df$保费)] <- 0

min.value <- min.value / diff(range(year.df$保费/1e8))


img <- paste0(work.path,"nine_line.png")
img_encoded <- dataURI(file = img, mime = "image/png")

p1 <- plot_geo() %>% 
  add_trace(
    type = "choropleth",
    geojson = china.data,
    locations = year.df$id,
    z = year.df$保费/1e8, 
    colorscale = list(c(0,"#f5f5f5"), c(min.value, "#f5f5f5"), c(min.value, "#ffffcd"), c(1,"#006834")), 
    showscale = TRUE, 
    colorbar = list(
      title = "保费规模(亿)",
      tickmode = "auto", 
      thickness = 15, 
      outlinewidth = 0
    ), 
    marker = list(line=list(width = 1, color="#778899"), opacity = 1), 
    hoverinfo="none", 
    text = paste0(year.df$省名称, ":", round(year.df$保费/1e8, 2), "亿")) %>% 
  add_markers(
    data = year.df, 
    x = ~lon, 
    y = ~lat, 
    marker = list(size = 30), 
    hoverinfo = "text", 
    text = ~paste0(`省名称`, ":", round(保费/1e8, 2), "亿"), 
    opacity = 0., 
    showlegend = FALSE
  ) %>% 
  add_text(
    data = province_centers, 
    x = ~lon, 
    y = ~lat,  
    showlegend = FALSE, 
    text = ~province, 
    textfont = list(size = 11), 
    hoverinfo = "none") %>% 
  layout(
    geo = list(
      zoom = 10,
      scope = "asia",
      resolution = 50,
      showframe = FALSE,
      center = list(lon = 105, lat = 38),
      projection = list(type = "mercator"),
      showland = TRUE,
      landcolor = "rgb(255, 255, 255)",
      countrycolor = "rgb(255, 255, 255)", 
      lonaxis = list(range = c(70,140), gridcolor = "gray"),
      lataxis = list(range = c(20.5,55.5), gridcolor = "gray")
    ), 
    images = list(  
      list(  
        source = img_encoded,  
        xref = "paper",  
        yref = "paper",  
        x = 1,  
        y = 0,  
        sizex = 0.25,  
        sizey = 0.25,
        xanchor="right",
        yanchor="bottom" 
      ) 
    ) 
  ) %>% 
  layout(dragmode=F, 
         title = list(text = img.title, x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)))


# p1

```


```{r}
# format output dataframe
sub.df <- year.df[order(year.df$保费,decreasing = T), c("省名称","保费","增速")]
colnames(sub.df) <- c("地区","保费规模(亿)","同比增速(%)")
sub.df$`保费规模(亿)` <- sub.df$`保费规模(亿)`/1e8
sub.df$`同比增速(%)` <- sub.df$`同比增速(%)`*100
sub.df.copy <- sub.df

sub.df$`保费规模(亿)` <- format(sub.df$`保费规模(亿)`, digits = 2)
sub.df$`同比增速(%)` <- format(sub.df$`同比增速(%)`, digits = 2)

alert.name <- c("河南","黑龙江","内蒙古","山东","江苏","河北",
                "安徽","湖南","四川","吉林","辽宁","江西","湖北")

t1 <- datatable(sub.df, rownames = F, caption = tab.title, 
                options = list(
                  lengthMenu = list(c(10)), 
                  searching = FALSE, 
                  dom = 'tip'
                  )
                ) %>%
  formatStyle("地区", target = 'cell', backgroundColor = styleEqual(alert.name, "#FFF8DC")) %>%
  formatStyle(names(sub.df), textAlign = "center")

# t1

combineWidgets(t1, p1, nrow = 1, colsize = c(1,2), width = 1150, height = 580)

sub.df.copy %>%
  download_this(
    output_name = tab.title,
    output_extension = ".xlsx",
    button_label = "下载数据",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )

```


<br>

```{r}
# 上一年度
year <- sort.UY[length(sort.UY)-1]
year.df <- Crop2.2[which(Crop2.2$UY==year), ]
if(year.df$进展期[1]>=4) {
  tab.title <- paste0(year, "年全国农险保费分省分布及增速")
  img.title <- paste0(year, "年全国农险保费分省分布")
} else {
  tab.title <- paste0(year, "年Q", year.df$进展期[1], "全国农险保费分省分布及增速")
  img.title <- paste0(year, "年Q", year.df$进展期[1], "全国农险保费分省分布")
}

```

```{r fig.width=9, fig.height=6}
year.df <- merge(year.df, china.df, by.x = "省名称", by.y = "name", all = TRUE)
year.df <- merge(year.df, province_centers, by.x = "省名称", by.y = "province", all.x = TRUE)

min.value <- min(year.df$保费/1e8, na.rm=T)
year.df$保费[is.na(year.df$保费)] <- 0

min.value <- min.value / diff(range(year.df$保费/1e8))

p <- plot_geo() %>% 
  add_trace(
    type = "choropleth",
    geojson = china.data,
    locations = year.df$id,
    z = year.df$保费/1e8, 
    colorscale = list(c(0,"#f5f5f5"), c(min.value, "#f5f5f5"), c(min.value, "#ffffcd"), c(1,"#006834")), 
    showscale = TRUE, 
    colorbar = list(
      title = "保费规模(亿)",
      tickmode = "auto", 
      thickness = 15, 
      outlinewidth = 0
    ), 
    marker = list(line=list(width = 1, color="#778899"), opacity = 1), 
    hoverinfo="none", 
    text = paste0(year.df$省名称, ":", round(year.df$保费/1e8, 2), "亿")) %>% 
  add_markers(
    data = year.df, 
    x = ~lon, 
    y = ~lat, 
    marker = list(size = 30), 
    hoverinfo = "text", 
    text = ~paste0(`省名称`, ":", round(保费/1e8, 2), "亿"), 
    opacity = 0., 
    showlegend = FALSE
  ) %>% 
  add_text(
    data = province_centers, 
    x = ~lon, 
    y = ~lat,  
    showlegend = FALSE, 
    text = ~province, 
    textfont = list(size = 11), 
    hoverinfo = "none") %>% 
  layout(
    geo = list(
      zoom = 10,
      scope = "asia",
      resolution = 50,
      showframe = FALSE,
      center = list(lon = 105, lat = 38),
      projection = list(type = "mercator"),
      showland = TRUE,
      landcolor = "rgb(255, 255, 255)",
      countrycolor = "rgb(255, 255, 255)", 
      lonaxis = list(range = c(70,140), gridcolor = "gray"),
      lataxis = list(range = c(20.5,55.5), gridcolor = "gray")
    ), 
    images = list(  
      list(  
        source = img_encoded,  
        xref = "paper",  
        yref = "paper",  
        x = 1,  
        y = 0,  
        sizex = 0.25,  
        sizey = 0.25,
        xanchor="right",
        yanchor="bottom" 
      ) 
    ) 
  ) %>% 
  layout(dragmode=F, 
         title = list(text = img.title, x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)))


# p

```

```{r}
# format output dataframe
sub.df <- year.df[order(year.df$保费,decreasing = T), c("省名称","保费","增速")]
colnames(sub.df) <- c("地区","保费规模(亿)","同比增速(%)")
sub.df$`保费规模(亿)` <- sub.df$`保费规模(亿)`/1e8
sub.df$`同比增速(%)` <- sub.df$`同比增速(%)`*100
sub.df.copy <- sub.df

sub.df$`保费规模(亿)` <- format(sub.df$`保费规模(亿)`, digits = 2)
sub.df$`同比增速(%)` <- format(sub.df$`同比增速(%)`, digits = 2)

alert.name <- c("河南","黑龙江","内蒙古","山东","江苏","河北",
                "安徽","湖南","四川","吉林","辽宁","江西","湖北")

t <- datatable(sub.df, rownames = F, caption = tab.title, 
               options = list(
                  lengthMenu = list(c(10)), 
                  searching = FALSE, 
                  dom = 'tip'
                  )
               ) %>%
  formatStyle("地区", target = 'cell', backgroundColor = styleEqual(alert.name, "#FFF8DC")) %>%
  formatStyle(names(sub.df), textAlign = "center")

# t

combineWidgets(t, p, nrow = 1, colsize = c(1,2), width = 1150, height = 580)

sub.df.copy %>%
  download_this(
    output_name = tab.title,
    output_extension = ".xlsx",
    button_label = "下载数据",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )

```

<br>

## 全国农险分地区分险种业务分布及增速概况

```{r}
Volume <- Crop %>%
  group_by(UY, 进展期, 省名称, Class) %>%
  summarize(保费=sum(签单保费))

Volume <- data.frame(Volume)
Volume$UY <- as.numeric(Volume$UY)
sort.UY <- sort(Volume$UY[!duplicated(Volume$UY)])
for(UY in sort.UY[-1]) {
  for(i in 1:nrow(Volume)) {
    if(Volume$UY[i]!=UY)
      next
    ind <- which(Volume$UY==UY-1 & Volume$进展期==Volume[i,"进展期"] & 
                   Volume$省名称==Volume[i,"省名称"] & Volume$Class==Volume[i,"Class"])
    if(length(ind)>0) {
      Volume[i,"增速"] <- Volume[i,"保费"] / Volume[ind,"保费"]-1
    } else {
      Volume[i,"增速"] <- NA
    }
  }
}

Volume <- Volume %>%
  group_by(UY, 省名称, Class) %>%
  slice(which.max(进展期))


# 种植险
year <- sort.UY[length(sort.UY)]
class <- "种植险"
year.df <- Volume[which(Volume$UY==year & Volume$Class==class), ]
if(year.df$进展期[1]>=4) {
  tab.title <- paste0(year,"年全国",class,"保费分省分布及增速")
  img.title <- paste0(year,"年全国",class,"保费分省分布")
} else {
  tab.title <- paste0(year, "年Q", year.df$进展期[1], "全国",class,"保费分省分布及增速")
  img.title <- paste0(year, "年Q", year.df$进展期[1], "全国",class,"保费分省分布")
}

```

```{r fig.width=9, fig.height=6}
year.df <- merge(year.df, china.df, by.x = "省名称", by.y = "name", all = TRUE)
year.df <- merge(year.df, province_centers, by.x = "省名称", by.y = "province", all.x = TRUE)

min.value <- min(year.df$保费/1e8, na.rm=T)
year.df$保费[is.na(year.df$保费)] <- 0

min.value <- min.value / diff(range(year.df$保费/1e8))

p <- plot_geo() %>% 
  add_trace(
    type = "choropleth",
    geojson = china.data,
    locations = year.df$id,
    z = year.df$保费/1e8, 
    colorscale = list(c(0,"#f5f5f5"), c(min.value, "#f5f5f5"), c(min.value, "#edf8fb"), c(1,"#006d28")), 
    showscale = TRUE, 
    colorbar = list(
      title = "保费规模(亿)",
      tickmode = "auto", 
      thickness = 15, 
      outlinewidth = 0
    ), 
    marker = list(line=list(width = 1, color="#778899"), opacity = 1), 
    hoverinfo="none", 
    text = paste0(year.df$省名称, ":", round(year.df$保费/1e8, 2), "亿")) %>% 
  add_markers(
    data = year.df, 
    x = ~lon, 
    y = ~lat, 
    marker = list(size = 30), 
    hoverinfo = "text", 
    text = ~paste0(`省名称`, ":", round(保费/1e8, 2), "亿"), 
    opacity = 0., 
    showlegend = FALSE
  ) %>% 
  add_text(
    data = province_centers, 
    x = ~lon, 
    y = ~lat,  
    showlegend = FALSE, 
    text = ~province, 
    textfont = list(size = 11), 
    hoverinfo = "none") %>% 
  layout(
    geo = list(
      zoom = 10,
      scope = "asia",
      resolution = 50,
      showframe = FALSE,
      center = list(lon = 105, lat = 38),
      projection = list(type = "mercator"),
      showland = TRUE,
      landcolor = "rgb(255, 255, 255)",
      countrycolor = "rgb(255, 255, 255)", 
      lonaxis = list(range = c(70,140), gridcolor = "gray"),
      lataxis = list(range = c(20.5,55.5), gridcolor = "gray")
    ), 
    images = list(  
      list(  
        source = img_encoded,  
        xref = "paper",  
        yref = "paper",  
        x = 1,  
        y = 0,  
        sizex = 0.25,  
        sizey = 0.25,
        xanchor="right",
        yanchor="bottom" 
      ) 
    ) 
  ) %>% 
  layout(dragmode=F, 
         title = list(text = img.title, x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)))


# p

```

```{r}
# format output dataframe
sub.df <- year.df[order(year.df$保费,decreasing = T), c("省名称","保费","增速")]
colnames(sub.df) <- c("地区","保费规模(亿)","同比增速(%)")
sub.df$`保费规模(亿)` <- sub.df$`保费规模(亿)`/1e8
sub.df$`同比增速(%)` <- sub.df$`同比增速(%)`*100
sub.df.copy <- sub.df

sub.df$`保费规模(亿)` <- format(sub.df$`保费规模(亿)`, digits = 2)
sub.df$`同比增速(%)` <- format(sub.df$`同比增速(%)`, digits = 2)

alert.name <- c("河南","黑龙江","内蒙古","山东","江苏","河北",
                "安徽","湖南","四川","吉林","辽宁","江西","湖北")

t <- datatable(sub.df, rownames = F, caption = tab.title, 
               options = list(
                  lengthMenu = list(c(10)), 
                  searching = FALSE, 
                  dom = 'tip'
                  )
               ) %>%
  formatStyle("地区", target = 'cell', backgroundColor = styleEqual(alert.name, "#FFF8DC")) %>%
  formatStyle(names(sub.df), textAlign = "center")

# t

combineWidgets(t, p, nrow = 1, colsize = c(1,2), width = 1150, height = 580)

sub.df.copy %>%
  download_this(
    output_name = tab.title,
    output_extension = ".xlsx",
    button_label = "下载数据",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )

```

<br>

```{r}
# 养殖险
year <- sort.UY[length(sort.UY)]
class <- "养殖险"
year.df <- Volume[which(Volume$UY==year & Volume$Class==class), ]
if(year.df$进展期[1]>=4) {
  tab.title <- paste0(year,"年全国",class,"保费分省分布及增速")
  img.title <- paste0(year,"年全国",class,"保费分省分布")
} else {
  tab.title <- paste0(year, "年Q", year.df$进展期[1], "全国",class,"保费分省分布及增速")
  img.title <- paste0(year, "年Q", year.df$进展期[1], "全国",class,"保费分省分布")
}

```

```{r fig.width=9, fig.height=6}
year.df <- merge(year.df, china.df, by.x = "省名称", by.y = "name", all = TRUE)
year.df <- merge(year.df, province_centers, by.x = "省名称", by.y = "province", all.x = TRUE)

min.value <- min(year.df$保费/1e8, na.rm=T)
year.df$保费[is.na(year.df$保费)] <- 0

min.value <- min.value / diff(range(year.df$保费/1e8))

p <- plot_geo() %>% 
  add_trace(
    type = "choropleth",
    geojson = china.data,
    locations = year.df$id,
    z = year.df$保费/1e8, 
    colorscale = list(c(0,"#f5f5f5"), c(min.value, "#f5f5f5"), c(min.value, "#ffffd5"), 
                      c((min.value+1)/2, "#fe9a24"), c(1,"#9a3100")), 
    showscale = TRUE, 
    colorbar = list(
      title = "保费规模(亿)",
      tickmode = "auto", 
      thickness = 15, 
      outlinewidth = 0
    ), 
    marker = list(line=list(width = 1, color="#778899"), opacity = 1), 
    hoverinfo="none", 
    text = paste0(year.df$省名称, ":", round(year.df$保费/1e8, 2), "亿")) %>% 
  add_markers(
    data = year.df, 
    x = ~lon, 
    y = ~lat, 
    marker = list(size = 30), 
    hoverinfo = "text", 
    text = ~paste0(`省名称`, ":", round(保费/1e8, 2), "亿"), 
    opacity = 0., 
    showlegend = FALSE
  ) %>% 
  add_text(
    data = province_centers, 
    x = ~lon, 
    y = ~lat,  
    showlegend = FALSE, 
    text = ~province, 
    textfont = list(size = 11), 
    hoverinfo = "none") %>% 
  layout(
    geo = list(
      zoom = 10,
      scope = "asia",
      resolution = 50,
      showframe = FALSE,
      center = list(lon = 105, lat = 38),
      projection = list(type = "mercator"),
      showland = TRUE,
      landcolor = "rgb(255, 255, 255)",
      countrycolor = "rgb(255, 255, 255)", 
      lonaxis = list(range = c(70,140), gridcolor = "gray"),
      lataxis = list(range = c(20.5,55.5), gridcolor = "gray")
    ), 
    images = list(  
      list(  
        source = img_encoded,  
        xref = "paper",  
        yref = "paper",  
        x = 1,  
        y = 0,  
        sizex = 0.25,  
        sizey = 0.25,
        xanchor="right",
        yanchor="bottom" 
      ) 
    ) 
  ) %>% 
  layout(dragmode=F, 
         title = list(text = img.title, x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)))


# p

```

```{r}
# format output dataframe
sub.df <- year.df[order(year.df$保费,decreasing = T), c("省名称","保费","增速")]
colnames(sub.df) <- c("地区","保费规模(亿)","同比增速(%)")
sub.df$`保费规模(亿)` <- sub.df$`保费规模(亿)`/1e8
sub.df$`同比增速(%)` <- sub.df$`同比增速(%)`*100
sub.df.copy <- sub.df

sub.df$`保费规模(亿)` <- format(sub.df$`保费规模(亿)`, digits = 2)
sub.df$`同比增速(%)` <- format(sub.df$`同比增速(%)`, digits = 2)

alert.name <- c("河南","黑龙江","内蒙古","山东","江苏","河北",
                "安徽","湖南","四川","吉林","辽宁","江西","湖北")

t <- datatable(sub.df, rownames = F, caption = tab.title, 
               options = list(
                  lengthMenu = list(c(10)), 
                  searching = FALSE, 
                  dom = 'tip'
                  )
               ) %>%
  formatStyle("地区", target = 'cell', backgroundColor = styleEqual(alert.name, "#FFF8DC")) %>%
  formatStyle(names(sub.df), textAlign = "center")

# t

combineWidgets(t, p, nrow = 1, colsize = c(1,2), width = 1150, height = 580)

sub.df.copy %>%
  download_this(
    output_name = tab.title,
    output_extension = ".xlsx",
    button_label = "下载数据",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )

```

<br>

## 全国农险分地区分险种业务分布特点

```{r}
Crop2.4 <- Crop %>%
  group_by(UY, 进展期, 省名称, Class) %>%
  summarize(保费=sum(签单保费))

Crop2.4 <- data.frame(Crop2.4)
Crop2.4$UY <- as.numeric(Crop2.4$UY)
sort.UY <- sort(Crop2.4$UY[!duplicated(Crop2.4$UY)])

Crop2.4 <- Crop2.4 %>%
  group_by(UY, 省名称, Class) %>%
  slice(which.max(进展期))

# latest year
year <- sort.UY[length(sort.UY)]
year.df <- Crop2.4[which(Crop2.4$UY==year), ]
if(year.df$进展期[1]>=4) {
  tab.title <- paste0(year, "年全国农险各省各险种占比")
  img.title <- paste0(year, "年全国农险各省各险种占比")
} else {
  tab.title <- paste0(year, "年Q", year.df$进展期[1], "全国农险各省各险种占比")
  img.title <- paste0(year, "年Q", year.df$进展期[1], "全国农险各省各险种占比")
}

year.df$保费占比 <- foreach(X = c(1:nrow(year.df)), .combine = "c") %do% {
  total <- sum(year.df$保费[which(year.df$省名称==year.df$省名称[X])])
  return(year.df$保费[X] / total * 100)
}

year.df <- year.df[, c("省名称","Class","保费占比")]

# long table to wide table
year.df <- reshape2::dcast(year.df, 省名称~Class)
year.df <- year.df[order(year.df$种植险, decreasing = T), ]
year.df$省名称 <- factor(year.df$省名称, levels = year.df$省名称)

year.df.copy <- year.df

# 百分比堆积条形图
my.color <- c("#9cbc58", "#c4d79c", "#f79744", my.palette)
p1 <- plot_ly(year.df, x = ~省名称, y = ~种植险, type = 'bar', name = '种植险') %>%
  add_trace(y = ~森林险, name = '森林险') %>%
  add_trace(y = ~养殖险, name = '养殖险') %>%
  layout(barmode = 'stack') %>% 
  layout(yaxis = list(title = "保费占比(%)"), 
         xaxis = list(title = "省份<br>(按种植险比重降序排列)"), 
         title = list(text = img.title, x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)), 
         margin = list(t = 15), 
         colorway = my.color, 
         bargap = .5)

p1

```

```{r fig.width=9, fig.height=6}
year.df <- merge(year.df, province_centers, by.x = "省名称", by.y = "province")

year.df[is.na(year.df)] <- 0.0

size.ref <- 1.8
p2 <- plot_geo() %>% 
  add_trace(
    type = "choropleth",
    geojson = china.data,
    locations = china.df$id %>% unlist() %>% unname(),
    z = 0, 
    colorscale = list(c(0,"rgb(250,250,250)"), c(1,"rgb(250,250,250)")), 
    showscale = FALSE,
    marker = list(line=list(width = 0.5, color="#778899"), opacity = 1), 
    hoverinfo='none'
  ) %>% 
  add_markers(
    data = year.df, 
    x = ~lon+runif(31,min = -0.1, max = 0.1), 
    y = ~lat+runif(31,min = -0.1, max = 0.1), 
    marker = list(size = ~`森林险`, sizemode = "diameter", sizeref = size.ref, color = "#c4d79c", line = list(color = "#D3D3D3")), 
    hoverinfo = "text", 
    text = ~paste0(`省名称`, "森林险:", round(`森林险`,2), "%"), 
    opacity = 0.6, 
    name = "森林险"
  )  %>%
  add_markers(
    data = year.df, 
    x = ~lon+runif(31,min = -0.1, max = 0.1), 
    y = ~lat+runif(31,min = -0.1, max = 0.1), 
    marker = list(size = ~`养殖险`, sizemode = "diameter", sizeref = size.ref, color = "#f79744", line = list(color = "#D3D3D3")), 
    hoverinfo = "text", 
    text = ~paste0(`省名称`, "养殖险:", round(`养殖险`,2), "%"), 
    opacity = 0.6, 
    name = "养殖险"
  ) %>% add_markers(
    data = year.df, 
    x = ~lon+runif(31,min = -0.1, max = 0.1), 
    y = ~lat+runif(31,min = -0.1, max = 0.1), 
    marker = list(size = ~`种植险`, sizemode = "diameter", sizeref = size.ref, color = "#9cbc58", line = list(color = "#D3D3D3")), 
    hoverinfo = "text", 
    text = ~paste0(`省名称`, "种植险:", round(`种植险`,2), "%"), 
    opacity = 0.6, 
    name = "种植险"
  ) %>% layout(
    geo = list(
      zoom = 10,
      scope = "asia",
      resolution = 50,
      showframe = FALSE,
      center = list(lon = 105, lat = 38),
      projection = list(type = "mercator"),
      showland = TRUE,
      landcolor = "rgb(255, 255, 255)",
      countrycolor = "rgb(255, 255, 255)", 
      lonaxis = list(range = c(70,140), gridcolor = "gray"),
      lataxis = list(range = c(20.5,55.5), gridcolor = "gray")
    ), 
    images = list(  
      list(  
        source = img_encoded,  
        xref = "paper",  
        yref = "paper",  
        x = 1,  
        y = 0,  
        sizex = 0.25,  
        sizey = 0.25,
        xanchor="right",
        yanchor="bottom" 
      ) 
    ) 
  ) %>% 
  layout(dragmode=F, 
         title = list(text = "各省分险种业务特点", 
                      x = 0.5, 
                      y = 0.98, 
                      xanchor = "center", 
                      yanchor = "middle", 
                      font = list(size = 18))) %>% 
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d")) 


p2




```


```{r fig.width=9, fig.height=6}
year.df <- year.df.copy

year.df$`种植&森林险` <- rowSums(year.df[,c("种植险","森林险")], na.rm = T)

year.df <- merge(year.df, china.df, by.x = "省名称", by.y = "name", all = TRUE)
year.df <- merge(year.df, province_centers, by.x = "省名称", by.y = "province", all.x = TRUE)

min.value <- min(year.df$`种植&森林险`, na.rm=T)
max.value <- max(year.df$`种植&森林险`, na.rm=T)
year.df$`种植&森林险`[is.na(year.df$`种植&森林险`)] <- 0
year.df$养殖险[is.na(year.df$养殖险)] <- 0
year.df$种植险[is.na(year.df$种植险)] <- 0
year.df$森林险[is.na(year.df$森林险)] <- 0

min.value <- min.value / diff(range(year.df$`种植&森林险`))

p1 <- plot_geo() %>% 
  add_trace(
    type = "choropleth",
    geojson = china.data,
    locations = year.df$id,
    z = year.df$`种植&森林险`, 
    colorscale = list(c(0,"#f5f5f5"), c(min.value, "#f5f5f5"), c(min.value, "#f4b185"), 
                      c((min.value+1)/2,"#fff2cd"), c((min.value+1)/2,"#fff2cd"), c(1,"#93d14f")), 
    showscale = TRUE, 
    colorbar = list(
      title = "分险种保费占比",
      # tickmode = "auto", 
      tickvals = c(min.value+10, max.value-10), 
      ticktext = c("养殖险为主", "种植&森林险为主"), 
      thickness = 15, 
      outlinewidth = 0, 
      orientation = "h", 
      y = 0, 
      titleside = "top"
    ), 
    marker = list(line=list(width = 1, color="#778899"), opacity = 1), 
    hoverinfo="none") %>% 
  add_markers(
    data = year.df, 
    x = ~lon, 
    y = ~lat, 
    marker = list(size = 30), 
    hoverinfo = "text", 
    text = paste0(year.df$省名称, "<br>种植险:", round(year.df$`种植险`, 2), 
                  "%<br>森林险:", round(year.df$`森林险`, 2), 
                  "%<br>养殖险:", round(year.df$`养殖险`, 2), "%"), 
    opacity = 0., 
    showlegend = FALSE
  ) %>% 
  add_text(
    data = province_centers, 
    x = ~lon, 
    y = ~lat,  
    showlegend = FALSE, 
    text = ~province, 
    textfont = list(size = 11), 
    hoverinfo = "none") %>% 
  layout(
    geo = list(
      zoom = 10,
      scope = "asia",
      resolution = 50,
      showframe = FALSE,
      center = list(lon = 105, lat = 38),
      projection = list(type = "mercator"),
      showland = TRUE,
      landcolor = "rgb(255, 255, 255)",
      countrycolor = "rgb(255, 255, 255)", 
      lonaxis = list(range = c(70,140), gridcolor = "gray"),
      lataxis = list(range = c(20.5,55.5), gridcolor = "gray")
    ), 
    images = list(  
      list(  
        source = img_encoded,  
        xref = "paper",  
        yref = "paper",  
        x = 1,  
        y = 0,  
        sizex = 0.25,  
        sizey = 0.25,
        xanchor="right",
        yanchor="bottom" 
      ) 
    ) 
  ) %>% 
  layout(dragmode=F, 
         title = list(text = "各省分险种业务特点", x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)))


p1

# combineWidgets(p2, p1, nrow = 1, colsize = c(1,1), width = 1150, height = 580)


```


## 农险市场增量动因分析

```{r}
Crop1 <- Crop[!is.na(Crop$标的), ]
Volume <- Crop1 %>%
  group_by(UY,进展期,Class,标的) %>%
  summarise(保费=sum(签单保费))
Volume <- data.frame(Volume)
Volume$UY <- as.numeric(Volume$UY)
sort.UY <- sort(Volume$UY[!duplicated(Volume$UY)])
for(UY in sort.UY[-1]) {
  for(i in 1:nrow(Volume)) {
    if(Volume$UY[i]!=UY)
      next
    ind <- which(Volume$UY==UY-1 & 
                   Volume$进展期==Volume[i,"进展期"] & 
                   Volume$Class==Volume[i,"Class"] & 
                   Volume$标的==Volume[i, "标的"])
    Volume[i,"增量"] <- (Volume[i,"保费"] - Volume[ind,"保费"])
  }
}
Volume <- Volume %>%
  group_by(UY,Class,标的) %>%
  slice(which.max(进展期))


# 种植险饼图
class <- "种植险"
year1 <- sort.UY[length(sort.UY)-1]
df1 <- Volume[which(Volume$UY==year1 & Volume$Class==class), ]
df1$Rate <- df1$增量/sum(df1$增量)
df1 <- df1[df1$增量>=0, ]
df1 <- df1[order(df1$Rate,decreasing = T), ]
if("其他" %in% df1$标的) {
  tmp <- df1[which(df1$标的=="其他"), ]
  df1 <- df1[-which(df1$标的=="其他"), ]
  df1 <- rbind(df1, tmp)
}

year2 <- sort.UY[length(sort.UY)]
df2 <- Volume[which(Volume$UY==year2 & Volume$Class==class), ]
df2$Rate <- df2$增量/sum(df2$增量)
df2 <- df2[df2$增量>=0, ]
df2 <- df2[order(df2$Rate,decreasing = T), ]
if("其他" %in% df2$标的) {
  tmp <- df2[which(df2$标的=="其他"), ]
  df2 <- df2[-which(df2$标的=="其他"), ]
  df2 <- rbind(df2, tmp)
}

img.title <- paste0(class,"不同标的增量贡献度<br>(仅展示保费增量大于0的标的)")

# p1 <- plot_ly() %>%
#   add_pie(
#     data = df1, labels = ~标的, values = ~Rate, type = 'pie',
#     textposition = 'auto', textinfo = 'label+percent',
#     hoverinfo = 'text', text = ~paste(标的,"<br>保费增量:",round(增量/1e8,2),"(亿)"),
#     marker = list(colors = brewer.pal(8, "Greens"),
#                   line = list(color = '#FFFFFF', width = 2)),
#     showlegend = FALSE,
#     title = list(text = paste0(year1,"年"), font = list(size = 14)),
#     domain = list(x = c(0.05, 0.45), y = c(0.05, 0.95)),
#     sort = FALSE) %>%
#   add_pie(
#     data = df2, labels = ~标的, values = ~Rate, type = 'pie',
#     textposition = 'auto', textinfo = 'label+percent',
#     hoverinfo = 'text', text = ~paste(标的,"<br>保费增量:",round(增量/1e8,2),"(亿)"),
#     marker = list(colors = brewer.pal(8, "Greens"),
#                   line = list(color = '#FFFFFF', width = 2)),
#     showlegend = FALSE,
#     title = list(text = paste0(year2,"年"), font = list(size = 14)),
#     domain = list(x = c(0.55, 0.95), y = c(0.05, 0.95)),
#     sort = FALSE) %>%
#   layout(
#     title = list(text = img.title, x = 0.5, y = 0.95,
#                  xanchor = "center", yanchor = "middle", font = list(size = 18)),
#     margin = list(t = 15, r = 45, b = -50),
#     xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
#     yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
# p1

p1 <- plot_ly() %>%
  add_pie(
    data = df1, labels = ~标的, values = ~Rate, type = 'pie', hole = 0.4, 
    textposition = 'auto', textinfo = 'label+percent',
    hoverinfo = 'text', text = ~paste(标的,"<br>保费增量:",round(增量/1e8,2),"(亿)"),
    marker = list(colors = rev(brewer.pal(8, "Greens"))[-1],
                  line = list(color = '#FFFFFF', width = 2)),
    showlegend = FALSE, 
    direction = "clockwise", 
    rotation = 0, 
    sort = FALSE) %>%
  layout(
    title = list(text = paste0(class,"<br>",year1,"年"), x = 0.52, y = 0.5,
                 xanchor = "center", yanchor = "middle", font = list(size = 14)),
    margin = list(t = 0, r = 45, b = 0),
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

# p1


p2 <- plot_ly() %>%
  add_pie(
    data = df2, labels = ~标的, values = ~Rate, type = 'pie', hole = 0.4, 
    textposition = 'auto', textinfo = 'label+percent',
    hoverinfo = 'text', text = ~paste(标的,"<br>保费增量:",round(增量/1e8,2),"(亿)"),
    marker = list(colors = rev(brewer.pal(8, "Greens"))[-1],
                  line = list(color = '#FFFFFF', width = 2)),
    showlegend = FALSE, 
    direction = "clockwise", 
    rotation = 0, 
    sort = FALSE) %>%
  layout(
    title = list(text = paste0(class,"<br>",year2,"年"), x = 0.52, y = 0.5,
                 xanchor = "center", yanchor = "middle", font = list(size = 14)),
    margin = list(t = 0, r = 45, b = 0),
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

# p2

# combineWidgets(p1, p2, nrow = 1, 
#                header = "<center><font size=4>种植险不同标的增量贡献度</font><br>(仅展示保费增量大于0的标的)</center>")




# 养殖险饼图
class <- "养殖险"
year1 <- sort.UY[length(sort.UY)]-1
df1 <- Volume[which(Volume$UY==year1 & Volume$Class==class), ]
df1$Rate <- df1$增量/sum(df1$增量)
df1 <- df1[df1$增量>=0, ]
df1 <- df1[order(df1$Rate,decreasing = T), ]
if("其他养殖" %in% df1$标的) {
  tmp <- df1[which(df1$标的=="其他养殖"), ]
  df1 <- df1[-which(df1$标的=="其他养殖"), ]
  df1 <- rbind(df1, tmp)
}



year2 <- sort.UY[length(sort.UY)]
df2 <- Volume[which(Volume$UY==year2 & Volume$Class==class), ]
df2$Rate <- df2$增量/sum(df2$增量)
df2 <- df2[df2$增量>=0, ]
df2 <- df2[order(df2$Rate,decreasing = T), ]
if("其他养殖" %in% df2$标的) {
  tmp <- df2[which(df2$标的=="其他养殖"), ]
  df2 <- df2[-which(df2$标的=="其他养殖"), ]
  df2 <- rbind(df2, tmp)
}

img.title <- paste0(class,"不同标的增量贡献度<br>(仅展示保费增量大于0的标的)")

# p2 <- plot_ly() %>%
#   add_pie(
#     data = df1, labels = ~标的, values = ~Rate, type = 'pie',
#     textposition = 'auto', textinfo = 'label+percent',
#     hoverinfo = 'text', text = ~paste(标的,"<br>保费增量:",round(增量/1e8,2),"(亿)"),
#     marker = list(colors = brewer.pal(8, "Oranges"),
#                   line = list(color = '#FFFFFF', width = 2)),
#     showlegend = FALSE,
#     title = list(text = paste0(year1,"年"), font = list(size = 14)),
#     domain = list(x = c(0.05, 0.45), y = c(0.05, 0.95)),
#     sort = FALSE) %>%
#   add_pie(
#     data = df2, labels = ~标的, values = ~Rate, type = 'pie',
#     textposition = 'auto', textinfo = 'label+percent',
#     hoverinfo = 'text', text = ~paste(标的,"<br>保费增量:",round(增量/1e8,2),"(亿)"),
#     marker = list(colors = brewer.pal(8, "Oranges"),
#                   line = list(color = '#FFFFFF', width = 2)),
#     showlegend = FALSE,
#     title = list(text = paste0(year2,"年"), font = list(size = 14)),
#     domain = list(x = c(0.55, 0.95), y = c(0.05, 0.95)),
#     sort = FALSE) %>%
#   layout(
#     title = list(text = img.title, x = 0.5, y = 0.95,
#                  xanchor = "center", yanchor = "middle", font = list(size = 18)),
#     margin = list(t = 15, r = 45),
#     xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
#     yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
# p2



p3 <- plot_ly() %>%
  add_pie(
    data = df1, labels = ~标的, values = ~Rate, type = 'pie', hole = 0.4, 
    textposition = 'auto', textinfo = 'label+percent',
    hoverinfo = 'text', text = ~paste(标的,"<br>保费增量:",round(增量/1e8,2),"(亿)"),
    marker = list(colors = rev(brewer.pal(8, "Oranges"))[-1],
                  line = list(color = '#FFFFFF', width = 2)),
    showlegend = FALSE, 
    direction = "clockwise", 
    rotation = 0, 
    sort = FALSE) %>%
  layout(
    title = list(text = paste0(class,"<br>",year1,"年"), x = 0.52, y = 0.5,
                 xanchor = "center", yanchor = "middle", font = list(size = 14)),
    margin = list(t = 0, r = 45, b = 0),
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

p4 <- plot_ly() %>%
  add_pie(
    data = df2, labels = ~标的, values = ~Rate, type = 'pie', hole = 0.4, 
    textposition = 'auto', textinfo = 'label+percent',
    hoverinfo = 'text', text = ~paste(标的,"<br>保费增量:",round(增量/1e8,2),"(亿)"),
    marker = list(colors = rev(brewer.pal(8, "Oranges"))[-1],
                  line = list(color = '#FFFFFF', width = 2)),
    showlegend = FALSE, 
    direction = "clockwise", 
    rotation = 0, 
    sort = FALSE) %>%
  layout(
    title = list(text = paste0(class,"<br>",year2,"年"), x = 0.52, y = 0.5,
                 xanchor = "center", yanchor = "middle", font = list(size = 14)),
    margin = list(t = 0, r = 45, b = 0),
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

```{r fig.width=8,fig.height=8}
combineWidgets(p1, p2, p3, p4, nrow = 2, 
               header = "<center><font size=4>分险种不同标的增量贡献度</font><br>(仅展示保费增量大于0的标的)</center>")
```


## 农险市场分险种标的发展规律


```{r}
Crop1 <- Crop[!is.na(Crop$标的), ]
Volume <- Crop1 %>%
  group_by(UY,进展期,Class,标的) %>%
  summarise(保费=sum(签单保费))
Volume <- data.frame(Volume)
Volume$UY <- as.numeric(Volume$UY)
sort.UY <- sort(Volume$UY[!duplicated(Volume$UY)])

Volume <- Volume %>%
  group_by(UY,Class,标的) %>%
  slice(which.max(进展期))


# 种植险饼图
class <- "种植险"
img.title <- paste0(class, "各标的近3年市场规模占比变化规律")
df <- Volume[which(Volume$Class==class),c("UY","保费","标的")]
df <- dcast(df, 标的~UY, value.var = "保费")

df <- df[order(df$`2022`, decreasing = T), ]
tmp <- df[which(df$标的=="其他"), ]
df <- df[-which(df$标的=="其他"), ]
df <- rbind(df, tmp)

p1 <- plot_ly(df) %>%
  add_pie(labels = ~`标的`, values = ~`2022`, type = 'pie', hole = 0.7, sort = F, 
          textposition = 'auto', textinfo = 'percent', 
          hoverinfo = 'text', text = ~paste("2022年",标的,"<br>保费:",round(`2022`/1e8,2),"(亿)"), 
          marker = list(colors = rev(brewer.pal(8, "Greens"))[-1], 
                        line = list(color = '#FFFFFF', width = 2)), 
          direction = "clockwise", 
          rotation = 0, 
          domain = list(
            x = c(0, 1), 
            y = c(0, 1)
          )) %>%
  add_pie(data, labels = ~`标的`, values = ~`2021`, hole = 0.5, sort = F, 
          textposition = 'auto', textinfo = 'percent', 
          hoverinfo = 'text', text = ~paste("2021年",标的,"<br>保费:",round(`2021`/1e8,2),"(亿)"), 
          marker = list(colors = rev(brewer.pal(8, "Greens"))[-1], 
                        line = list(color = '#FFFFFF', width = 2)), 
          direction = "clockwise", 
          rotation = 0, 
          domain = list(
            x = c(0.15, 0.85),
            y = c(0.15, 0.85))) %>% 
  add_pie(data, labels = ~`标的`, values = ~`2020`, hole = 0.2, sort = F, 
          textposition = 'auto', textinfo = 'percent', 
          hoverinfo = 'text', text = ~paste("2020年",标的,"<br>保费:",round(`2020`/1e8,2),"(亿)"), 
          marker = list(colors = rev(brewer.pal(8, "Greens"))[-1], 
                        line = list(color = '#FFFFFF', width = 2)), 
          direction = "clockwise", 
          rotation = 0, 
          domain = list(
            x = c(0.3, 0.7),
            y = c(0.3, 0.7))) %>% 
  add_annotations(
    x = 0.6, y = 0.6, 
    xref = "paper", yref = "paper", 
    text = "2020年", 
    showarrow = F,
    ax = -30, ay = -30, 
    arrowwidth = 0.8, 
    bgcolor = "white",
    bordercolor = "black") %>% 
  add_annotations(
    x = 0.8, y = 0.7, 
    xref = "paper", yref = "paper", 
    text = "2021年", 
    showarrow = F,
    ax = -30, ay = -30, 
    arrowwidth = 0.8, 
    bgcolor = "white",
    bordercolor = "black") %>% 
  add_annotations(
    x = 0.95, y = 0.8, 
    xref = "paper", yref = "paper", 
    text = "2022年", 
    showarrow = F,
    ax = -30, ay = -30, 
    arrowwidth = 0.8, 
    bgcolor = "white",
    bordercolor = "black") %>% 
  layout(
    title = list(text = img.title, x = 0.5, y = 0.95, 
                 xanchor = "center", yanchor = "middle", font = list(size = 18)), 
    margin = list(t = 40), 
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE), 
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

# p1


# 养殖险饼图
class <- "养殖险"
img.title <- paste0(class, "各标的近3年市场规模占比变化规律")
df <- Volume[which(Volume$Class==class),c("UY","保费","标的")]
df <- dcast(df, 标的~UY, value.var = "保费")

df <- df[order(df$`2022`, decreasing = T), ]
tmp <- df[which(df$标的=="其他养殖"), ]
df <- df[-which(df$标的=="其他养殖"), ]
df <- rbind(df, tmp)

p2 <- plot_ly(df) %>%
  add_pie(labels = ~`标的`, values = ~`2022`, type = 'pie', hole = 0.7, sort = F, 
          textposition = 'auto', textinfo = 'percent', 
          hoverinfo = 'text', text = ~paste("2022年",标的,"<br>保费:",round(`2022`/1e8,2),"(亿)"), 
          marker = list(colors = rev(brewer.pal(8, "Oranges"))[-1], 
                        line = list(color = '#FFFFFF', width = 2)), 
          direction = "clockwise", 
          rotation = 0, 
          domain = list(
            x = c(0, 1), 
            y = c(0, 1)
          )) %>%
  add_pie(data, labels = ~`标的`, values = ~`2021`, hole = 0.5, sort = F, 
          textposition = 'auto', textinfo = 'percent', 
          hoverinfo = 'text', text = ~paste("2021年",标的,"<br>保费:",round(`2021`/1e8,2),"(亿)"), 
          marker = list(colors = rev(brewer.pal(8, "Oranges"))[-1], 
                        line = list(color = '#FFFFFF', width = 2)), 
          direction = "clockwise", 
          rotation = 0, 
          domain = list(
            x = c(0.15, 0.85),
            y = c(0.15, 0.85))) %>% 
  add_pie(data, labels = ~`标的`, values = ~`2020`, hole = 0.2, sort = F, 
          textposition = 'auto', textinfo = 'percent', 
          hoverinfo = 'text', text = ~paste("2020年",标的,"<br>保费:",round(`2020`/1e8,2),"(亿)"), 
          marker = list(colors = rev(brewer.pal(8, "Oranges"))[-1], 
                        line = list(color = '#FFFFFF', width = 2)), 
          direction = "clockwise", 
          rotation = 0, 
          domain = list(
            x = c(0.3, 0.7),
            y = c(0.3, 0.7))) %>% 
  add_annotations(
    x = 0.6, y = 0.6, 
    xref = "paper", yref = "paper", 
    text = "2020年", 
    showarrow = F,
    ax = 30, ay = -30, 
    arrowwidth = 0.8, 
    bgcolor = "white",
    bordercolor = "black") %>% 
  add_annotations(
    x = 0.80, y = 0.7, 
    xref = "paper", yref = "paper", 
    text = "2021年", 
    showarrow = F,
    ax = 30, ay = -30, 
    arrowwidth = 0.8, 
    bgcolor = "white",
    bordercolor = "black") %>% 
  add_annotations(
    x = 0.95, y = 0.8, 
    xref = "paper", yref = "paper", 
    text = "2022年", 
    showarrow = F,
    ax = 30, ay = -30, 
    arrowwidth = 0.8, 
    bgcolor = "white",
    bordercolor = "black") %>% 
  layout(
    title = list(text = img.title, x = 0.5, y = 0.95, 
                 xanchor = "center", yanchor = "middle", font = list(size = 18)), 
    margin = list(t = 40), 
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE), 
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
# p2

```

```{r fig.width=11}
combineWidgets(p1, p2, nrow = 1)
```


## 分地区各市场主体竞争格局

```{r}
Crop1 <- Crop[!is.na(Crop$机构), ]
Volume <- Crop1 %>%
  group_by(UY,进展期,省名称,机构) %>%
  summarise(保费=sum(签单保费))
Volume <- data.frame(Volume)
Volume$UY <- as.numeric(Volume$UY)
sort.UY <- sort(Volume$UY[!duplicated(Volume$UY)])

Volume <- Volume %>%
  group_by(UY,省名称,机构) %>%
  slice(which.max(进展期))

Volume$保费 <- round(Volume$保费/1e8, 2)

# 最新年度
year <- sort.UY[length(sort.UY)]
df <- Volume[which(Volume$UY==year), c("省名称","机构","保费")]
df <- dcast(df, 省名称~机构, value.var = "保费")

img.title <- paste0(year, "年分地区各市场主体竞争格局")

df <- df[order(rowSums(df[,c(2:4)],na.rm = T), decreasing = T), ]
df$省名称 <- factor(df$省名称, levels = df$省名称)

my.color <- c("#f4b284", "#9ec4e7", "#aad28f", "#ffda66", "#d1cfcf")

p <- plot_ly(df, x = ~`省名称`, y = ~`头部主体`, type = 'bar', name = '头部主体')
for (col in c("专业性主体","成长型主体","区域性主体","其他主体")) {
  if(col %in% names(df)) {
    p <- p %>% add_trace(y = df[,col], name = col)
  }
}
p <- p %>% 
  layout(title = list(text = img.title, x = 0.5, y = 0.98,
                         xanchor = "center", yanchor = "middle", 
                         font = list(size = 18)), 
         xaxis = list(title = '省份<br>(按保费规模降序排列)', dtick = 1), 
         yaxis = list(title = '保费(亿)'), 
         margin = list(t = 15, r = 50), 
         bargap = 0.5, 
         barmode = 'stack', 
         colorway = my.color)
p

```






<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>

